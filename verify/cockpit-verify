#!/bin/sh

set -ex

if [ -n "$TMPDIR" ]; then
    mkdir -p "$TMPDIR"
    mkdir -p $TMPDIR/libvirt
    rm -rf /tmp/libvirt
    ln -snf $TMPDIR/libvirt /tmp/libvirt
fi

if [ ! -d cockpit ]; then
    sudo chown -R user /build
    git clone https://github.com/cockpit-project/cockpit
fi

(cd cockpit && npm install)
mkdir -p mock

echo "Starting testing"

while true; do
    fail=0
    find cockpit -name '*.py?' -delete
    git -C cockpit fetch origin master
    git -C cockpit reset --hard FETCH_HEAD
    cockpit/test/vm-download --prune

    if ! git diff -C cockpit --exit-code origin/master package.json; then
        (cd cockpit && npm install)
    fi

    if ! cockpit/test/github-task "$@"; then
        exit
    fi
done
