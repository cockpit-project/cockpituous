#!/bin/sh

set -ex

if [ -n "$TMPDIR" ]; then
    mkdir -p "$TMPDIR"
fi

if [ ! -d cockpit ]; then
    sudo chown -R user /build
    git clone https://github.com/cockpit-project/cockpit
fi

if [ ! -d cockpit/tools/node_modules ]; then
    ( cd cockpit/tools && npm install )
fi

mkdir -p mock

echo "Starting testing of $TEST_OS"

while true; do
    fail=0
    for os in $TEST_OS; do
	    git -C cockpit reset --hard origin/master
	    if ! TEST_OS=$os cockpit/test/check-verify --install --rebase "$@"; then
            fail=1
        fi
    done
    if [ $fail != 0 ]; then
        sleep 60
    fi
done
