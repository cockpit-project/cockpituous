---
- name: "Upload tasks service installation script"
  copy:
    src: "{{ role_path }}/../../../tasks/install-service"
    dest: /run/install-service
    mode: preserve

- name: Create custom SELinux rules to fix Chromium
  copy:
    dest: /tmp/cockpituous.te
    mode: 0644
    content: |
      module cockpituous 1.0;
      require {
              type container_t;
              class process execheap;
      }

      # HACK: See https://github.com/cockpit-project/cockpituous/issues/579
      allow container_t self:process execheap;
  register: selinux_policy

- name: Install custom SELinux rules
  shell: |
    checkmodule -M -m -o /tmp/cockpituous.mod /tmp/cockpituous.te
    semodule_package -o /tmp/cockpituous.pp -m /tmp/cockpituous.mod
    semodule -i /tmp/cockpituous.pp
  when: selinux_policy.changed

# This only applies to RH VPN; make that optional if we ever deploy to public infrastructure
- name: Create npm configuration
  copy:
    dest: /etc/npmrc
    mode: 0644
    content: |
      registry=https://repository.engineering.redhat.com/nexus/repository/registry.npmjs.org/
      fetch-retries=6
      fetch-timeout=600000
      fetch-retry-mintimeout=60000
      maxsockets=3
      cafile=/run/secrets/tasks/npm-registry.crt

- name: Set up systemd service for cockpit/tasks
  shell: |
    export INSTANCES={{ instances | default(4) }}
    export TEST_NOTIFICATION_MX={{ notification_mx | default('') }}
    export TEST_NOTIFICATION_TO={{ notification_to | default('') }}
    /run/install-service
